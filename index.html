<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Intelligence Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root{--bg:#0a0c0f;--bg2:#111318;--bg3:#181c23;--border:#1e2530;--gold:#c9a84c;--gold2:#f0c96e;--green:#2ecc71;--red:#e74c3c;--blue:#4a9eff;--purple:#9b59b6;--cyan:#1abc9c;--text:#e8ecf3;--muted:#7a8499}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh}
  /* LOADING */
  #ls{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s}
  #ls.hidden{opacity:0;pointer-events:none}
  .lt{font-size:13px;letter-spacing:4px;color:var(--gold);text-transform:uppercase;margin-bottom:32px}
  .lbw{width:280px;height:2px;background:#1e2530;border-radius:2px;overflow:hidden}
  .lb{height:2px;background:linear-gradient(90deg,var(--gold),var(--gold2));width:0%;transition:width .4s;border-radius:2px}
  .lstat{font-size:11px;color:var(--muted);margin-top:14px;font-family:'Space Mono',monospace}
  /* OFFLINE BADGE */
  .offline-note{background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:10px 16px;font-size:11px;color:var(--gold2);font-family:'Space Mono',monospace;margin-bottom:20px;display:none}
  .offline-note.visible{display:block}
  /* HEADER */
  .header{background:linear-gradient(180deg,#0d1017 0%,var(--bg) 100%);border-bottom:1px solid var(--border);padding:18px 32px;display:flex;align-items:center;justify-content:space-between}
  .header-left .label{font-size:10px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:2px}
  .header-left h1{font-size:22px;font-weight:800}
  .header-left .sub{font-size:11px;color:var(--muted);margin-top:3px}
  .header-right{text-align:right}
  .header-right .pl{font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase}
  .header-right .pv{font-size:34px;font-weight:800;color:var(--gold2);font-family:'Space Mono',monospace;line-height:1}
  .header-right .ps{font-size:12px;font-family:'Space Mono',monospace;margin-top:3px}
  .live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(46,204,113,.12);border:1px solid rgba(46,204,113,.3);padding:4px 10px;border-radius:20px;font-size:10px;color:var(--green);font-family:'Space Mono',monospace;margin-left:12px;vertical-align:middle}
  .live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
  .static-badge{display:none;align-items:center;gap:6px;background:rgba(201,168,76,.12);border:1px solid rgba(201,168,76,.3);padding:4px 10px;border-radius:20px;font-size:10px;color:var(--gold2);font-family:'Space Mono',monospace;margin-left:12px;vertical-align:middle}
  .static-badge.visible{display:inline-flex}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
  /* TABS */
  .tabs{background:var(--bg2);border-bottom:1px solid var(--border);display:flex;padding:0 32px;align-items:center;justify-content:space-between}
  .tabs-left{display:flex;gap:4px}
  .tab{padding:14px 22px;font-size:13px;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .2s;background:none;border-top:none;border-left:none;border-right:none;font-family:'Syne',sans-serif;letter-spacing:.5px}
  .tab:hover{color:var(--text)}.tab.active{color:var(--gold);border-bottom-color:var(--gold)}
  .refresh-btn{background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.3);color:var(--gold);padding:6px 14px;border-radius:6px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
  .refresh-btn:hover{background:rgba(201,168,76,.2)}
  .refresh-btn.spinning .icon{display:inline-block;animation:spin .7s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* CONTENT */
  .content{padding:28px 32px}
  .tab-panel{display:none}.tab-panel.active{display:block}
  /* KPIs */
  .kpi-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:24px}
  .kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px 18px;position:relative;overflow:hidden}
  .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
  .kpi-card.gold::before{background:var(--gold)}.kpi-card.green::before{background:var(--green)}
  .kpi-card.red::before{background:var(--red)}.kpi-card.blue::before{background:var(--blue)}
  .kpi-card.purple::before{background:var(--purple)}.kpi-card.cyan::before{background:var(--cyan)}
  .kpi-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
  .kpi-val{font-size:22px;font-weight:700;font-family:'Space Mono',monospace;line-height:1}
  .kpi-val.green{color:var(--green)}.kpi-val.red{color:var(--red)}.kpi-val.gold{color:var(--gold2)}
  .kpi-sub{font-size:11px;color:var(--muted);margin-top:6px;font-family:'Space Mono',monospace}
  /* GRIDS */
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
  /* PANELS */
  .panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
  .panel-title{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:16px;display:flex;align-items:center;gap:8px}
  .panel-title .dot{width:6px;height:6px;border-radius:50%;background:var(--gold)}
  /* TOP5 */
  .top5-item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
  .top5-item:last-child{border-bottom:none}
  .t5n{font-size:13px;font-weight:700;min-width:90px}
  .t5bw{flex:1;margin:0 12px;height:4px;background:#1a1f28;border-radius:2px}
  .t5b{height:4px;border-radius:2px}
  .t5v{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;min-width:70px;text-align:right}
  .t5v.green{color:var(--green)}.t5v.red{color:var(--red)}
  /* TABLE */
  table{width:100%;border-collapse:collapse}
  thead th{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
  tbody td{padding:11px 12px;font-size:13px;border-bottom:1px solid #141820;font-family:'Space Mono',monospace}
  tbody tr:hover{background:#131720}
  .badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-family:'Syne',sans-serif;font-weight:700}
  .bc{background:rgba(155,89,182,.2);color:#c39bd3}
  .be{background:rgba(74,158,255,.2);color:#85c1f5}
  .ba{background:rgba(46,204,113,.2);color:#82e0aa}
  .bf{background:rgba(201,168,76,.2);color:var(--gold2)}
  .bct{background:rgba(26,188,156,.2);color:#76d7c4}
  /* TREEMAP */
  #treemap{width:100%;height:280px;position:relative;overflow:hidden;border-radius:6px}
  .tc{position:absolute;border:1px solid var(--bg2);border-radius:3px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:default;transition:filter .2s;overflow:hidden}
  .tc:hover{filter:brightness(1.2);z-index:10}
  .cn{font-size:11px;font-weight:700;color:rgba(255,255,255,.9);text-align:center}
  .cr{font-size:10px;font-family:'Space Mono',monospace;margin-top:3px}
  /* LIQUIDITY */
  .liq-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
  .liq-row:last-child{border-bottom:none}
  .ld{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .ln{width:100px;font-weight:700}
  .lbwrap{flex:1;height:6px;background:#1a1f28;border-radius:3px;overflow:hidden}
  .lbar{height:6px;border-radius:3px}
  .ltag{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:700;margin-left:4px}
  .ltag.instant{background:rgba(46,204,113,.2);color:var(--green)}
  .ltag.fast{background:rgba(74,158,255,.2);color:var(--blue)}
  .ltag.slow{background:rgba(201,168,76,.2);color:var(--gold2)}
  /* SCORE */
  .sr{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .sn{font-size:12px;width:120px}
  .sbw{flex:1;height:8px;background:#1a1f28;border-radius:4px;overflow:hidden}
  .sb{height:8px;border-radius:4px}
  .sv{font-size:11px;font-family:'Space Mono',monospace;min-width:50px;text-align:right}
  /* DIAG */
  .di{display:flex;gap:14px;padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid var(--border);background:var(--bg3)}
  .dico{font-size:20px;flex-shrink:0}
  .dtt{font-size:13px;font-weight:700;margin-bottom:4px}
  .dtx{font-size:12px;color:var(--muted);line-height:1.5}
  .di.good .dtt{color:var(--green)}.di.warn .dtt{color:var(--gold2)}.di.bad .dtt{color:var(--red)}
  /* EFF */
  .ei{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-radius:7px;margin-bottom:7px;background:var(--bg3);border:1px solid var(--border)}
  .en{font-size:13px;font-weight:700}
  .em{font-size:11px;color:var(--muted);font-family:'Space Mono',monospace}
  .et{font-size:10px;padding:3px 8px;border-radius:4px;font-weight:700}
  .et.eficiente{background:rgba(46,204,113,.15);color:var(--green);border:1px solid rgba(46,204,113,.3)}
  .et.ineficiente{background:rgba(231,76,60,.15);color:var(--red);border:1px solid rgba(231,76,60,.3)}
  .et.neutro{background:rgba(201,168,76,.15);color:var(--gold2);border:1px solid rgba(201,168,76,.3)}
  .lu{font-size:10px;color:var(--muted);font-family:'Space Mono',monospace}
</style>
</head>
<body>

<div id="ls">
  <div class="lt">â—† Portfolio Intelligence</div>
  <div class="lbw"><div class="lb" id="lb"></div></div>
  <div class="lstat" id="lstat">Conectando con Google Sheets...</div>
</div>

<div class="header">
  <div class="header-left">
    <div class="label">â—† Portfolio Intelligence Dashboard</div>
    <h1>Mi Portafolio
      <span class="live-badge" id="live-badge"><span class="live-dot"></span>LIVE</span>
      <span class="static-badge" id="static-badge">ðŸ“‹ DATOS LOCALES</span>
    </h1>
    <div class="sub" id="header-sub">Cargando...</div>
  </div>
  <div class="header-right">
    <div class="pl">Valor Total del Portafolio</div>
    <div class="pv" id="header-total">â€”</div>
    <div class="ps" id="header-pyg">â€”</div>
  </div>
</div>

<div class="tabs">
  <div class="tabs-left">
    <button class="tab active" onclick="showTab('resumen',this)">â—† Resumen</button>
    <button class="tab" onclick="showTab('riesgo',this)">â—‡ Riesgo / Retorno</button>
    <button class="tab" onclick="showTab('profundo',this)">â—ˆ AnÃ¡lisis Profundo</button>
    <button class="tab" onclick="showTab('detalle',this)">â˜° Detalle</button>
  </div>
  <div style="padding:8px 0;display:flex;align-items:center;gap:12px">
    <span class="lu" id="last-update"></span>
    <button class="refresh-btn" id="refresh-btn" onclick="loadData()"><span class="icon">â†º</span> Actualizar</button>
  </div>
</div>

<div class="content">

  <div class="offline-note" id="offline-note">
    âš¡ Mostrando datos locales (Ãºltima sesiÃ³n). En Vercel con tu Google Sheet publicada como CSV, se cargarÃ¡ en tiempo real automÃ¡ticamente.
  </div>

  <!-- RESUMEN -->
  <div class="tab-panel active" id="tab-resumen">
    <div class="kpi-grid">
      <div class="kpi-card gold"><div class="kpi-label">Total Invertido</div><div class="kpi-val gold" id="kpi-inv">â€”</div><div class="kpi-sub">COP</div></div>
      <div class="kpi-card green"><div class="kpi-label">P&L Total</div><div class="kpi-val" id="kpi-pyg">â€”</div><div class="kpi-sub" id="kpi-roi-sub">â€”</div></div>
      <div class="kpi-card blue"><div class="kpi-label">Posiciones</div><div class="kpi-val" style="color:var(--blue)" id="kpi-pos">â€”</div><div class="kpi-sub" id="kpi-cust">â€”</div></div>
      <div class="kpi-card purple"><div class="kpi-label">Volatilidad Est.</div><div class="kpi-val" style="color:var(--purple)" id="kpi-vol">â€”</div><div class="kpi-sub">Ponderada portafolio</div></div>
      <div class="kpi-card red"><div class="kpi-label">Max DD Est.</div><div class="kpi-val red" id="kpi-mdd">â€”</div><div class="kpi-sub">Escenario adverso</div></div>
      <div class="kpi-card cyan"><div class="kpi-label">Ratio Sharpe</div><div class="kpi-val" style="color:var(--cyan)" id="kpi-sharpe">â€”</div><div class="kpi-sub">Retorno/Riesgo</div></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot"></span>DistribuciÃ³n por Clase de Activo</div><div style="height:220px;position:relative"><canvas id="cClase"></canvas></div></div>
      <div class="panel"><div class="panel-title"><span class="dot"></span>DistribuciÃ³n por Custodio</div><div style="height:220px;position:relative"><canvas id="cBroker"></canvas></div></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--green)"></span>Top 5 Rendimiento</div><div id="top5"></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--red)"></span>Bottom 5 Rendimiento</div><div id="bot5"></div></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot"></span>Mapa de Posiciones <span style="color:var(--muted);font-size:10px;font-family:'Space Mono'">TamaÃ±o = Valor Â· Color = P&L</span></div>
      <div id="treemap"></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot"></span>DistribuciÃ³n Sectorial</div><div style="height:220px;position:relative"><canvas id="cSector"></canvas></div></div>
      <div class="panel"><div class="panel-title"><span class="dot"></span>DistribuciÃ³n GeogrÃ¡fica</div><div style="height:220px;position:relative"><canvas id="cGeo"></canvas></div></div>
    </div>
  </div>

  <!-- RIESGO -->
  <div class="tab-panel" id="tab-riesgo">
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="kpi-card red"><div class="kpi-label">Volatilidad Portafolio</div><div class="kpi-val red" id="kpi-vol2">â€”</div><div class="kpi-sub">Ponderada por peso</div></div>
      <div class="kpi-card red"><div class="kpi-label">Max Drawdown Est.</div><div class="kpi-val red" id="kpi-mdd2">â€”</div><div class="kpi-sub">Escenario adverso</div></div>
      <div class="kpi-card gold"><div class="kpi-label">Ratio Sharpe</div><div class="kpi-val gold" id="kpi-sharpe2">â€”</div><div class="kpi-sub">Retorno/Riesgo</div></div>
      <div class="kpi-card purple"><div class="kpi-label">ExposiciÃ³n DD Severo</div><div class="kpi-val" style="color:var(--purple)" id="kpi-ddexp">â€”</div><div class="kpi-sub">Activos >70% vol</div></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot"></span>Mapa Riesgo / Retorno por Activo</div>
      <div style="height:320px;position:relative"><canvas id="cScatter"></canvas></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot"></span>Volatilidad Estimada por Activo (%)</div><div style="height:260px;position:relative"><canvas id="cVol"></canvas></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--red)"></span>Max Drawdown Estimado por Activo</div><div style="height:260px;position:relative"><canvas id="cDD"></canvas></div></div>
    </div>
    <div class="panel" style="margin-top:16px">
      <div class="panel-title"><span class="dot" style="background:var(--blue)"></span>Mapa de Liquidez</div>
      <div id="liq-map"></div>
    </div>
  </div>

  <!-- PROFUNDO -->
  <div class="tab-panel" id="tab-profundo">
    <div class="grid-2" style="margin-bottom:16px">
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--green)"></span>Activos Eficientes</div><div id="eficientes"></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--red)"></span>Activos Ineficientes</div><div id="ineficientes"></div></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot" style="background:var(--red)"></span>ExposiciÃ³n a Drawdown Severo (>âˆ’50%)</div>
      <div style="height:160px;position:relative"><canvas id="cDDExp"></canvas></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot" style="background:var(--blue)"></span>Score de Calidad por DimensiÃ³n</div>
      <div id="quality" style="padding:8px 0"></div>
    </div>
    <div class="panel">
      <div class="panel-title"><span class="dot" style="background:var(--gold)"></span>DiagnÃ³stico Integral y Recomendaciones</div>
      <div id="diag"></div>
    </div>
  </div>

  <!-- DETALLE -->
  <div class="tab-panel" id="tab-detalle">
    <div class="panel">
      <div class="panel-title"><span class="dot"></span>Tabla Detallada de Posiciones</div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th>TICKER</th><th>CLASE</th><th>CUSTODIO</th><th>DIVISA</th>
            <th>INVERTIDO</th><th>SALDO</th><th>P&L</th>
            <th>ROI</th><th>PESO %</th><th>VOL.</th><th>MAX DD</th><th>EFICIENCIA</th>
          </tr></thead>
          <tbody id="tabla"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================================
// TU GOOGLE SHEET CSV URL
// ============================================================
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZLeM8ZIZ4v8B-XJ8XZSi0rvZ-umEyoAlRCswkiWMOD64CUx1M22kf2axTWElyzslLpClm_DDAgO1Y/pub?gid=1310764306&single=true&output=csv';

// ============================================================
// DATOS DE RESPALDO (tus datos reales â€” se usan si no hay red)
// ============================================================
const FALLBACK = [
  {ticker:'NU BANK', broker:'NU HOLDINGS', div:'COP', inv:10000000, pyg:494315,   saldo:10494315, roi:0.0494},
  {ticker:'DINÃMICO',broker:'ACCIVALORES',  div:'COP', inv:3411934,  pyg:1061098,  saldo:4473032,  roi:0.3110},
  {ticker:'VWRA',    broker:'IBKR',         div:'USD', inv:6204544,  pyg:-101716,  saldo:6102828,  roi:-0.0164},
  {ticker:'WSML',    broker:'IBKR',         div:'USD', inv:842382,   pyg:56876,    saldo:899258,   roi:0.0675},
  {ticker:'AGGU',    broker:'IBKR',         div:'USD', inv:1349340,  pyg:-47427,   saldo:1301913,  roi:-0.0351},
  {ticker:'SGOL',    broker:'IBKR',         div:'USD', inv:1021730,  pyg:100663,   saldo:1122393,  roi:0.0985},
  {ticker:'TESLA',   broker:'HAPI',         div:'USD', inv:370873,   pyg:31395,    saldo:402268,   roi:0.0847},
  {ticker:'NU',      broker:'HAPI',         div:'USD', inv:400418,   pyg:45631,    saldo:446049,   roi:0.1140},
  {ticker:'BTC',     broker:'LEDGER',       div:'USD', inv:12078551, pyg:-95066,   saldo:11983485, roi:-0.0079},
  {ticker:'XRP',     broker:'LEDGER',       div:'USD', inv:567112,   pyg:151516,   saldo:718628,   roi:0.2672},
  {ticker:'ETH',     broker:'LEDGER',       div:'USD', inv:904202,   pyg:-615279,  saldo:288923,   roi:-0.6805},
  {ticker:'XAUT',    broker:'BITGET',       div:'USD', inv:208392,   pyg:80339,    saldo:288731,   roi:0.3855},
];

// ============================================================
// MAPAS DE CLASIFICACIÃ“N â€” agrega nuevos activos aquÃ­
// ============================================================
const CM={'NU BANK':'Cuenta Rentable','DINÃMICO':'FIC','DINAMICO':'FIC','VWRA':'ETF','WSML':'ETF','AGGU':'ETF','SGOL':'ETF','TESLA':'AcciÃ³n','NU':'AcciÃ³n','BTC':'Cripto','XRP':'Cripto','ETH':'Cripto','XAUT':'Cripto'};
const SM={'NU BANK':'Liquidez','DINÃMICO':'Diversificado','DINAMICO':'Diversificado','VWRA':'Global Eq.','WSML':'Small Cap','AGGU':'Renta Fija','SGOL':'Commodities','TESLA':'Tech','NU':'Fintech','BTC':'Cripto','XRP':'Cripto','ETH':'Cripto','XAUT':'Oro Digital'};
const GM={'NU BANK':'LATAM','DINÃMICO':'Colombia','DINAMICO':'Colombia','VWRA':'Global','WSML':'Global','AGGU':'Global','SGOL':'Global','TESLA':'EE.UU','NU':'LATAM','BTC':'Global','XRP':'Global','ETH':'Global','XAUT':'Global'};
const VM={'NU BANK':0.5,'DINÃMICO':2,'DINAMICO':2,'VWRA':15,'WSML':22,'AGGU':6,'SGOL':13,'TESLA':65,'NU':50,'BTC':75,'XRP':90,'ETH':85,'XAUT':13};
const DM={'NU BANK':-2,'DINÃMICO':-8,'DINAMICO':-8,'VWRA':-38,'WSML':-45,'AGGU':-20,'SGOL':-22,'TESLA':-75,'NU':-65,'BTC':-80,'XRP':-92,'ETH':-90,'XAUT':-22};
const LM={'NU BANK':'instant','DINÃMICO':'fast','DINAMICO':'fast','VWRA':'fast','WSML':'fast','AGGU':'fast','SGOL':'fast','TESLA':'fast','NU':'fast','BTC':'instant','XRP':'instant','ETH':'instant','XAUT':'fast'};
const COLORS={'Cripto':'#9b59b6','ETF':'#4a9eff','AcciÃ³n':'#2ecc71','FIC':'#c9a84c','Cuenta Rentable':'#1abc9c'};
const GC=['#2ecc71','#4a9eff','#c9a84c','#9b59b6','#e74c3c','#1abc9c','#f39c12'];

Chart.defaults.color='#7a8499';Chart.defaults.borderColor='#1e2530';Chart.defaults.font.family="'Space Mono',monospace";Chart.defaults.font.size=11;
let ch={};
const dc=id=>{if(ch[id]){ch[id].destroy();delete ch[id];}};
const fc=v=>{if(Math.abs(v)>=1e9)return'$'+(v/1e9).toFixed(2)+'B';if(Math.abs(v)>=1e6)return'$'+(v/1e6).toFixed(2)+'M';if(Math.abs(v)>=1e3)return'$'+(v/1e3).toFixed(1)+'K';return'$'+v.toFixed(0);};
const fp=v=>(v>=0?'+':'')+(v*100).toFixed(1)+'%';
const tn=v=>{if(!v||v==='-'||v==='--')return 0;return parseFloat(String(v).replace(/,/g,'').replace(/%/g,''))||0;};
const sl=(p,m)=>{document.getElementById('lb').style.width=p+'%';document.getElementById('lstat').textContent=m;};

function showTab(name,el){document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+name).classList.add('active');el.classList.add('active');}

function parseCSV(t){
  const lines=t.trim().split('\n').map(l=>{const r=[];let c='',q=false;for(let ch of l){if(ch==='"'){q=!q;}else if(ch===','&&!q){r.push(c.trim());c='';}else{c+=ch;}}r.push(c.trim());return r;});
  if(lines.length<2)return[];
  const h=lines[0].map(x=>x.replace(/"/g,'').trim().toUpperCase());
  return lines.slice(1).filter(r=>r.some(c=>c&&c!=='')).map(row=>{const o={};h.forEach((hh,i)=>{o[hh]=(row[i]||'').replace(/"/g,'').trim();});return o;});
}

function rowsToAssets(rows){
  return rows.map(r=>{
    const ticker=(r['TICKER']||r['ACTIVO']||'').toUpperCase().trim();
    const broker=r['BROKER']||r['CUSTODIO']||'';
    const div=r['DIVISA']||'COP';
    const inv=tn(r['INVERTIDO']||r['CAPITAL']||0);
    const pyg=tn(r["P&G"]||r["P&L"]||r['GANANCIA']||0);
    const saldo=tn(r['SALDO']||r['VALOR']||0)||(inv+pyg);
    const roi=tn(r['ROI']||0)||(inv>0?pyg/inv:0);
    return{ticker,broker,div,inv,pyg,saldo,roi,clase:CM[ticker]||'Otro',sector:SM[ticker]||'Otro',geo:GM[ticker]||'Global',vol:VM[ticker]||20,maxdd:DM[ticker]||-30,liquidity:LM[ticker]||'fast'};
  }).filter(a=>a.ticker&&a.saldo>0);
}

function enrichFallback(data){
  return data.map(a=>{const t=a.ticker;return{...a,clase:CM[t]||'Otro',sector:SM[t]||'Otro',geo:GM[t]||'Global',vol:VM[t]||20,maxdd:DM[t]||-30,liquidity:LM[t]||'fast'};});
}

async function loadData(){
  const btn=document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  sl(10,'Conectando con Google Sheets...');
  let assets=null,isLive=false;
  try{
    const res=await fetch(CSV_URL+'&t='+Date.now());
    sl(50,'Procesando datos...');
    if(!res.ok)throw new Error('HTTP '+res.status);
    const text=await res.text();
    const rows=parseCSV(text);
    if(!rows.length)throw new Error('Sin datos');
    assets=rowsToAssets(rows);
    if(assets.length)isLive=true;
  }catch(e){
    console.warn('Google Sheets no disponible, usando datos locales:',e.message);
  }
  if(!assets||!assets.length){
    assets=enrichFallback(FALLBACK);
    document.getElementById('offline-note').classList.add('visible');
    document.getElementById('live-badge').style.display='none';
    document.getElementById('static-badge').classList.add('visible');
  } else {
    document.getElementById('offline-note').classList.remove('visible');
    document.getElementById('live-badge').style.display='';
    document.getElementById('static-badge').classList.remove('visible');
  }
  sl(80,'Construyendo dashboard...');
  buildDashboard(assets,isLive);
  sl(100,'âœ“ Listo');
  setTimeout(()=>document.getElementById('ls').classList.add('hidden'),400);
  document.getElementById('last-update').textContent=(isLive?'ðŸŸ¢ Live â€” ':'ðŸ“‹ Local â€” ')+'Actualizado: '+new Date().toLocaleString('es-CO');
  btn.classList.remove('spinning');
}

function buildDashboard(assets,isLive){
  const tS=assets.reduce((s,a)=>s+a.saldo,0);
  const tI=assets.reduce((s,a)=>s+a.inv,0);
  const tP=assets.reduce((s,a)=>s+a.pyg,0);
  const roiG=tI>0?tP/tI:0;
  const volP=(assets.reduce((s,a)=>s+(a.vol*(a.saldo/tS)),0)).toFixed(1);
  const mddP=(assets.reduce((s,a)=>s+(a.maxdd*(a.saldo/tS)),0)).toFixed(1);
  const sharpe=(roiG/(parseFloat(volP)/100||0.31)).toFixed(2);
  const ddExp=assets.filter(a=>a.maxdd<=-50).reduce((s,a)=>s+a.saldo,0);
  const brokers=[...new Set(assets.map(a=>a.broker))].length;

  document.getElementById('header-total').textContent=fc(tS);
  const pe=document.getElementById('header-pyg');pe.textContent=fp(roiG)+' ('+fc(tP)+' COP)';pe.style.color=tP>=0?'var(--green)':'var(--red)';
  document.getElementById('header-sub').innerHTML=new Date().toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'})+' &nbsp;Â·&nbsp; '+assets.length+' posiciones &nbsp;Â·&nbsp; '+brokers+' custodios';
  document.getElementById('kpi-inv').textContent=fc(tI);
  const pk=document.getElementById('kpi-pyg');pk.textContent=fc(tP);pk.className='kpi-val '+(tP>=0?'green':'red');
  document.getElementById('kpi-roi-sub').textContent=fp(roiG)+' ROI global';
  document.getElementById('kpi-pos').textContent=assets.length;
  document.getElementById('kpi-cust').textContent=brokers+' custodios';
  document.getElementById('kpi-vol').textContent='~'+volP+'%';
  document.getElementById('kpi-vol2').textContent='~'+volP+'%';
  document.getElementById('kpi-mdd').textContent=mddP+'%';
  document.getElementById('kpi-mdd2').textContent=mddP+'%';
  document.getElementById('kpi-sharpe').textContent=sharpe;
  document.getElementById('kpi-sharpe2').textContent=sharpe;
  document.getElementById('kpi-ddexp').textContent=(ddExp/tS*100).toFixed(1)+'%';

  bClase(assets,tS);bBroker(assets,tS);bTop5(assets);bTreemap(assets,tS);
  bSector(assets,tS);bGeo(assets,tS);bScatter(assets,tS);
  bVol(assets);bDD(assets);bLiq(assets,tS);
  bEff(assets);bDDExp(assets,tS);bQuality(assets,roiG,sharpe);
  bDiag(assets,tS,roiG,sharpe);bTabla(assets,tS);
}

function bClase(A,tS){dc('cClase');const m={};A.forEach(a=>{m[a.clase]=(m[a.clase]||0)+a.saldo;});const L=Object.keys(m);ch['cClase']=new Chart(document.getElementById('cClase'),{type:'doughnut',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:L.map(l=>COLORS[l]||'#666'),borderColor:'#0a0c0f',borderWidth:3,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:12,boxWidth:10}},tooltip:{callbacks:{label:c=>` ${c.label}: ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}}}});}
function bBroker(A,tS){dc('cBroker');const m={};A.forEach(a=>{m[a.broker]=(m[a.broker]||0)+a.saldo;});const L=Object.keys(m).sort((a,b)=>m[b]-m[a]);const C=['#c9a84c','#4a9eff','#9b59b6','#2ecc71','#1abc9c','#e74c3c','#f39c12'];ch['cBroker']=new Chart(document.getElementById('cBroker'),{type:'bar',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:C.slice(0,L.length),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>fc(v)}},y:{grid:{display:false}}}}});}
function bTop5(A){const s=[...A].sort((a,b)=>b.roi-a.roi),t5=s.slice(0,5),b5=s.slice(-5).reverse();const mR=Math.abs(t5[0].roi)||1,mB=Math.abs(b5[0].roi)||1;const mk=(d,el,mx)=>{el.innerHTML='';d.forEach(a=>{const c=a.roi>=0?'var(--green)':'var(--red)';el.innerHTML+=`<div class="top5-item"><span class="t5n">${a.ticker}</span><div class="t5bw"><div class="t5b" style="width:${Math.abs(a.roi/mx)*100}%;background:${c}"></div></div><span class="t5v ${a.roi>=0?'green':'red'}">${fp(a.roi)}</span></div>`;});};mk(t5,document.getElementById('top5'),mR);mk(b5,document.getElementById('bot5'),mB);}
function bTreemap(A,tS){const c=document.getElementById('treemap');c.innerHTML='';const W=c.offsetWidth||900,H=280;c.style.height=H+'px';const items=[...A].sort((a,b)=>b.saldo-a.saldo);const gc=r=>{if(r>=.2)return'#1a6b3c';if(r>=.08)return'#1e5c35';if(r>=.01)return'#1a4a2e';if(r>=-.01)return'#2a3020';if(r>=-.1)return'#4a2020';return'#5c1414';};function lay(its,x,y,w,h){if(!its.length)return[];const res=[];let rem=[...its],rx=x,ry=y,rw=w,rh=h;while(rem.length){const isH=rw>=rh;let rI=[],rS=0,best=Infinity;for(let i=0;i<rem.length;i++){const cnd=rem.slice(0,i+1);const sum=cnd.reduce((s,c)=>s+c.saldo,0);const remS=rem.reduce((s,c)=>s+c.saldo,0);const rl=(sum/remS)*(isH?rw:rh);const sd=isH?rh:rw;const w2=Math.max(...cnd.map(c=>{const h2=(c.saldo/sum)*sd,ww=rl;return Math.max(h2/ww,ww/h2);}));if(w2<best){best=w2;rI=cnd.slice();rS=sum;}else break;}if(!rI.length){rI=[rem[0]];rS=rem[0].saldo;}const remS=rem.reduce((s,c)=>s+c.saldo,0);const rl=(rS/remS)*(isH?rw:rh);let pos=isH?ry:rx;rI.forEach(item=>{const fr=item.saldo/rS;const cw=isH?rl:fr*rw,ch=isH?fr*rh:rl;const cx=isH?rx:pos,cy=isH?pos:ry;res.push({...item,x:cx,y:cy,w:cw,h:ch});pos+=isH?ch:cw;});rem=rem.slice(rI.length);if(isH){rx+=rl;rw-=rl;}else{ry+=rl;rh-=rl;}}return res;}
lay(items,0,0,W,H).forEach(cell=>{const d=document.createElement('div');d.className='tc';d.style.cssText=`left:${cell.x}px;top:${cell.y}px;width:${Math.max(cell.w-2,1)}px;height:${Math.max(cell.h-2,1)}px;background:${gc(cell.roi)};`;const rc=cell.roi>=0?'#4ade80':'#f87171';if(cell.w>50&&cell.h>30)d.innerHTML=`<span class="cn">${cell.ticker}</span><span class="cr" style="color:${rc}">${fp(cell.roi)}</span>`;else if(cell.w>25&&cell.h>18)d.innerHTML=`<span class="cn" style="font-size:9px">${cell.ticker}</span>`;d.title=`${cell.ticker}: ${fc(cell.saldo)} Â· ROI: ${fp(cell.roi)}`;c.appendChild(d);});}
function bSector(A,tS){dc('cSector');const m={};A.forEach(a=>{m[a.sector]=(m[a.sector]||0)+a.saldo;});const L=Object.keys(m).sort((a,b)=>m[b]-m[a]);const C=['#4a9eff','#9b59b6','#2ecc71','#c9a84c','#1abc9c','#e74c3c','#f39c12','#3498db'];ch['cSector']=new Chart(document.getElementById('cSector'),{type:'bar',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:C.slice(0,L.length),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>fc(v)}},y:{grid:{display:false}}}}});}
function bGeo(A,tS){dc('cGeo');const m={};A.forEach(a=>{m[a.geo]=(m[a.geo]||0)+a.saldo;});const L=Object.keys(m);ch['cGeo']=new Chart(document.getElementById('cGeo'),{type:'doughnut',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:GC.slice(0,L.length),borderColor:'#0a0c0f',borderWidth:3,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:12,boxWidth:10}},tooltip:{callbacks:{label:c=>` ${c.label}: ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}}}});}
function bScatter(A,tS){dc('cScatter');const ds=Object.keys(COLORS).map(cl=>({label:cl,data:A.filter(a=>a.clase===cl).map(a=>({x:a.vol,y:a.roi*100,label:a.ticker})),backgroundColor:COLORS[cl]+'cc',pointRadius:A.filter(a=>a.clase===cl).map(a=>Math.max(6,Math.sqrt(a.saldo/tS)*80)),pointHoverRadius:12})).filter(d=>d.data.length);ch['cScatter']=new Chart(document.getElementById('cScatter'),{type:'scatter',data:{datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},tooltip:{callbacks:{label:c=>` ${c.raw.label}: ROI ${c.raw.y.toFixed(1)}% Â· Vol ${c.raw.x}%`}}},scales:{x:{title:{display:true,text:'Volatilidad (%)',color:'#7a8499'},grid:{color:'#1e2530'},min:0},y:{title:{display:true,text:'ROI (%)',color:'#7a8499'},grid:{color:'#1e2530'}}}}});}
function bVol(A){dc('cVol');const s=[...A].sort((a,b)=>b.vol-a.vol);ch['cVol']=new Chart(document.getElementById('cVol'),{type:'bar',data:{labels:s.map(a=>a.ticker),datasets:[{data:s.map(a=>a.vol),backgroundColor:s.map(a=>a.vol>50?'#e74c3c':a.vol>20?'#f0c96e':'#2ecc71'),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw}% vol. anual est.`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>v+'%'},max:100},y:{grid:{display:false},ticks:{font:{size:10}}}}}});}
function bDD(A){dc('cDD');const s=[...A].sort((a,b)=>a.maxdd-b.maxdd);ch['cDD']=new Chart(document.getElementById('cDD'),{type:'bar',data:{labels:s.map(a=>a.ticker),datasets:[{data:s.map(a=>a.maxdd),backgroundColor:s.map(a=>a.maxdd<-60?'#e74c3c':a.maxdd<-30?'#f0c96e':'#4a9eff'),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw}% DD mÃ¡ximo est.`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>v+'%'},max:0,min:-100},y:{grid:{display:false},ticks:{font:{size:10}}}}}});}
function bLiq(A,tS){const c=document.getElementById('liq-map');c.innerHTML='';const lc={instant:'#2ecc71',fast:'#4a9eff',slow:'#c9a84c',illiquid:'#e74c3c'};const ll={instant:'Inmediata',fast:'RÃ¡pida (1-3d)',slow:'Lenta (7-30d)',illiquid:'IlÃ­quida'};[...A].sort((a,b)=>b.saldo-a.saldo).forEach(a=>{const p=(a.saldo/tS*100).toFixed(1);c.innerHTML+=`<div class="liq-row"><div class="ld" style="background:${lc[a.liquidity]}"></div><div class="ln">${a.ticker}</div><div class="lbwrap"><div class="lbar" style="width:${p}%;background:${lc[a.liquidity]}"></div></div><span style="font-size:11px;font-family:'Space Mono';min-width:50px;text-align:right">${p}%</span><span class="ltag ${a.liquidity}">${ll[a.liquidity]}</span><span style="font-size:11px;color:var(--muted);min-width:80px;text-align:right;font-family:'Space Mono'">${fc(a.saldo)}</span></div>`;});}
function bEff(A){const ef=[],in2=[];A.forEach(a=>{const sc=a.roi/(a.vol/100+0.001);let st,reason;if(a.roi>=0.08&&a.vol<=15){st='eficiente';reason=`ROI +${(a.roi*100).toFixed(1)}% con baja volatilidad (${a.vol}%)`;}else if(a.roi<-0.03||(a.roi<0.05&&a.vol>60)){st='ineficiente';reason=a.roi<-0.1?`PÃ©rdida severa (${fp(a.roi)}) con alta vol (${a.vol}%)`:`Bajo retorno vs riesgo (vol ${a.vol}%)`;}else{st='neutro';reason=`Perfil mixto Â· ROI ${fp(a.roi)} Â· Vol ${a.vol}%`;}(st==='ineficiente'?in2:ef).push({...a,st,reason});});const rend=(items,el)=>{el.innerHTML='';[...items].sort((a,b)=>b.roi-a.roi).forEach(a=>{el.innerHTML+=`<div class="ei"><div><div class="en">${a.ticker} <span style="font-size:11px;color:var(--muted);font-weight:400">Â· ${a.clase}</span></div><div class="em">${a.reason}</div></div><div style="text-align:right"><div style="font-family:'Space Mono';font-size:13px;color:${a.roi>=0?'var(--green)':'var(--red)'}">${fp(a.roi)}</div><span class="et ${a.st}">${a.st.toUpperCase()}</span></div></div>`;});if(!items.length)el.innerHTML='<p style="color:var(--muted);font-size:12px;padding:12px">Ninguno en esta categorÃ­a</p>';};rend(ef,document.getElementById('eficientes'));rend(in2,document.getElementById('ineficientes'));}
function bDDExp(A,tS){dc('cDDExp');const sev=A.filter(a=>a.maxdd<=-50),norm=A.filter(a=>a.maxdd>-50);const vn=norm.reduce((s,a)=>s+a.saldo,0);ch['cDDExp']=new Chart(document.getElementById('cDDExp'),{type:'bar',data:{labels:sev.map(a=>a.ticker).concat(['Resto portafolio']),datasets:[{data:sev.map(a=>a.saldo).concat([vn]),backgroundColor:sev.map(a=>a.saldo>5e6?'#e74c3c':'#e74c3c88').concat(['#2ecc71']),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>fc(v)}},y:{grid:{display:false}}}}});}
function bQuality(A,roiG,sharpe){const tS=A.reduce((s,a)=>s+a.saldo,0);const t1=[...A].sort((a,b)=>b.saldo-a.saldo)[0];const con=t1?t1.saldo/tS:0;const liqS=A.filter(a=>a.liquidity==='instant'||a.liquidity==='fast').reduce((s,a)=>s+a.saldo,0)/tS*100;const scores=[{d:'DiversificaciÃ³n',v:Math.round(Math.max(0,100-con*150)),n:`${t1?.ticker||'?'} concentra ${(con*100).toFixed(0)}%`},{d:'Liquidez',v:Math.round(liqS),n:'MayorÃ­a inmediata/rÃ¡pida'},{d:'Eficiencia (Sharpe)',v:Math.max(5,Math.min(95,Math.round(parseFloat(sharpe)*40))),n:`Sharpe ${sharpe}`},{d:'Cobertura',v:45,n:'Sin cobertura explÃ­cita'},{d:'Calidad activos',v:62,n:'Mix ETFs + cripto + FIC'},{d:'Rentabilidad',v:Math.round(Math.max(5,Math.min(95,roiG*200+40))),n:`ROI global ${fp(roiG)}`}];const c=document.getElementById('quality');c.innerHTML='';scores.forEach(s=>{const col=s.v>=70?'var(--green)':s.v>=50?'var(--gold2)':'var(--red)';c.innerHTML+=`<div class="sr"><span class="sn">${s.d}</span><div class="sbw"><div class="sb" style="width:${s.v}%;background:${col}"></div></div><span class="sv" style="color:${col}">${s.v}/100</span><span style="font-size:11px;color:var(--muted);margin-left:12px;font-family:'Space Mono'">${s.n}</span></div>`;});}
function bDiag(A,tS,roiG,sharpe){const worst=[...A].sort((a,b)=>a.roi-b.roi)[0];const best=[...A].filter(a=>a.roi>0.05&&a.vol<15).sort((a,b)=>b.roi-a.roi)[0];const top1=[...A].sort((a,b)=>b.saldo-a.saldo)[0];const conc=(top1.saldo/tS*100).toFixed(1);const items=[worst.roi<-0.15?{t:'bad',i:'âš ï¸',tt:`${worst.ticker}: PosiciÃ³n en pÃ©rdida severa (${fp(worst.roi)})`,tx:`${worst.ticker} acumula ${fc(worst.pyg)} COP de pÃ©rdida sobre ${fc(worst.inv)} COP invertidos. Representa el ${(worst.saldo/tS*100).toFixed(1)}% del portafolio. Considera definir un umbral de salida o reasignar hacia activos mÃ¡s eficientes.`}:null,parseFloat(conc)>25?{t:'bad',i:'ðŸ”´',tt:`ConcentraciÃ³n excesiva en ${top1.ticker} (${conc}%)`,tx:`${top1.ticker} representa el ${conc}% del portafolio total. Una correcciÃ³n del 30% en este activo impactarÃ­a el portafolio en ~${(parseFloat(conc)*0.3).toFixed(1)}%. MÃ¡ximo recomendado: 20-25% por activo.`}:null,parseFloat(sharpe)<0.3?{t:'warn',i:'ðŸ“Š',tt:`Sharpe Ratio bajo (${sharpe}) â€” Eficiencia mejorable`,tx:`El portafolio asume alta volatilidad pero el ROI realizado es ${fp(roiG)}. Aumentar el peso en activos con mejor ratio Sharpe (ETFs globales, FICs, oro) elevarÃ­a la eficiencia del portafolio.`}:null,{t:'warn',i:'âš–ï¸',tt:'Ausencia de cobertura (hedge) explÃ­cita',tx:'No hay instrumentos de cobertura explÃ­cita. SGOL y AGGU actÃºan parcialmente como refugio, pero representan poco del portafolio. Objetivo: 10-15% en activos refugio mejora la resiliencia en caÃ­das.'},best?{t:'good',i:'âœ…',tt:`${best.ticker}: Activo mÃ¡s eficiente (+${(best.roi*100).toFixed(1)}% ROI Â· Vol ${best.vol}%)`,tx:`${best.ticker} entrega excelente rentabilidad con baja volatilidad. Es el activo mÃ¡s eficiente del portafolio. Considera mantener o incrementar su peso en nuevas contribuciones.`}:null,{t:'good',i:'ðŸ’§',tt:'Alta liquidez del portafolio',tx:'La mayorÃ­a de posiciones tienen liquidez inmediata o rÃ¡pida (1-3 dÃ­as hÃ¡biles). Esto permite rebalancear con flexibilidad total sin penalizaciones de salida anticipada.'}].filter(Boolean);const c=document.getElementById('diag');c.innerHTML='';items.forEach(it=>{c.innerHTML+=`<div class="di ${it.t}"><span class="dico">${it.i}</span><div><div class="dtt">${it.tt}</div><div class="dtx">${it.tx}</div></div></div>`;});}
function bTabla(A,tS){const tb=document.getElementById('tabla');tb.innerHTML='';const bm={'Cripto':'bc','ETF':'be','AcciÃ³n':'ba','FIC':'bf','Cuenta Rentable':'bct'};[...A].sort((a,b)=>b.saldo-a.saldo).forEach(a=>{const ef=a.roi/(a.vol/100+0.001);const el=ef>0.5?'EFICIENTE':ef>0?'NEUTRO':'INEFICIENTE';const ec=el==='EFICIENTE'?'var(--green)':el==='NEUTRO'?'var(--gold2)':'var(--red)';tb.innerHTML+=`<tr><td style="font-weight:700">${a.ticker}</td><td><span class="badge ${bm[a.clase]||''}">${a.clase}</span></td><td style="color:var(--muted)">${a.broker}</td><td style="color:var(--muted)">${a.div}</td><td>${fc(a.inv)}</td><td>${fc(a.saldo)}</td><td style="color:${a.pyg>=0?'var(--green)':'var(--red)'}">${fc(a.pyg)}</td><td style="color:${a.roi>=0?'var(--green)':'var(--red)'}">${fp(a.roi)}</td><td style="color:var(--muted)">${(a.saldo/tS*100).toFixed(1)}%</td><td style="color:${a.vol>50?'var(--red)':a.vol>20?'var(--gold2)':'var(--green)'}">${a.vol}%</td><td style="color:${a.maxdd<-60?'var(--red)':a.maxdd<-30?'var(--gold2)':'var(--blue)'}">${a.maxdd}%</td><td style="color:${ec};font-size:11px;font-family:'Syne'">${el}</td></tr>`;});}

// INIT
loadData();
// Auto-refresh cada 5 minutos (solo activo cuando hay conexiÃ³n)
setInterval(loadData,5*60*1000);
</script>
</body>
</html>
