<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Intelligence Dashboard</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23f0c96e'/><stop offset='100%25' style='stop-color:%23c9a84c'/></linearGradient></defs><polygon points='50,8 92,50 50,92 8,50' fill='url(%23g)'/><polygon points='50,20 80,50 50,80 20,50' fill='%230a0c0f' opacity='0.3'/></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#0a0c0f;--bg2:#141820;--panel:#1a1f28;--text:#e8ecf2;--muted:#7a8499;--border:#2a3240;--blue:#4a9eff;--green:#4ade80;--red:#f87171;--gold:#f0c96e;--gold2:#c9a84c;--purple:#9b59b6}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,var(--bg) 0%,#0f1218 100%);color:var(--text);padding:20px;min-height:100vh}
  .container{max-width:1400px;margin:0 auto}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;background:linear-gradient(135deg,rgba(240,201,110,0.12),rgba(74,158,255,0.08));backdrop-filter:blur(20px);border:1px solid rgba(240,201,110,0.25);border-radius:12px;padding:20px 24px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#f0c96e,#c9a84c);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#0a0c0f;box-shadow:0 4px 12px rgba(240,201,110,0.3)}
  .logo-text{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;background:linear-gradient(135deg,#f0c96e,#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .header-actions{display:flex;gap:12px;align-items:center}
  .status{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  .refresh-btn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0c0f;border:none;border-radius:8px;padding:10px 18px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s;box-shadow:0 2px 8px rgba(240,201,110,0.3)}
  .refresh-btn:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(240,201,110,0.5)}
  .refresh-btn.spinning{animation:spin 1s linear infinite}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .loading-bar-wrap{background:rgba(42,50,64,0.5);height:4px;border-radius:2px;overflow:hidden;margin-bottom:20px}
  .loading-bar{height:4px;background:linear-gradient(90deg,var(--blue),var(--green));border-radius:2px;width:0%;transition:width 0.3s}
  .loading-status{font-size:11px;color:var(--muted);margin-top:4px}
  .kpi-grid{display:grid;gap:16px;margin-bottom:20px}
  .kpi-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;transition:all 0.2s}
  .kpi-card:hover{border-color:rgba(240,201,110,0.4);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
  .kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px}
  .kpi-val{font-family:'Space Mono',monospace;font-size:28px;font-weight:700;margin-bottom:4px}
  .kpi-val.green{color:var(--green)}
  .kpi-val.red{color:var(--red)}
  .kpi-val.gold{color:var(--gold)}
  .kpi-val.purple{color:var(--purple)}
  .kpi-sub{font-size:11px;color:var(--muted)}
  .kpi-change{font-size:12px;font-weight:600;margin-top:4px}
  .tabs{display:flex;gap:8px;margin-bottom:20px;background:var(--panel);padding:8px;border-radius:12px;border:1px solid var(--border)}
  .tab{background:transparent;color:var(--muted);border:none;border-radius:8px;padding:10px 20px;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:13px}
  .tab:hover{background:rgba(240,201,110,0.1);color:var(--text)}
  .tab.active{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0c0f;box-shadow:0 2px 8px rgba(240,201,110,0.3)}
  .tab-panel{display:none}
  .tab-panel.active{display:block}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
  .panel-title{font-size:14px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;color:var(--text)}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--gold)}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .top5-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
  .top5-item:last-child{border-bottom:none}
  .t5n{width:80px;font-weight:700;font-size:13px}
  .t5bw{flex:1;height:8px;background:rgba(42,50,64,0.5);border-radius:4px;overflow:hidden}
  .t5b{height:8px;border-radius:4px}
  .t5v{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;min-width:60px;text-align:right}
  .t5v.green{color:var(--green)}
  .t5v.red{color:var(--red)}
  .tc{position:absolute;border:1px solid rgba(10,12,15,0.8);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;transition:all 0.15s}
  .tc:hover{transform:scale(1.05);z-index:10;border-color:var(--gold);box-shadow:0 4px 16px rgba(0,0,0,0.5)}
  .cn{font-weight:700;font-size:11px;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.8)}
  .cr{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,0.8)}
  table{width:100%;border-collapse:collapse;font-size:12px}
  thead{background:rgba(42,50,64,0.5);position:sticky;top:0}
  th{text-align:left;padding:12px;font-weight:600;text-transform:uppercase;font-size:10px;letter-spacing:1px;color:var(--muted);border-bottom:1px solid var(--border)}
  td{padding:10px 12px;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace}
  tr:hover{background:rgba(240,201,110,0.05)}
  .badge{font-size:10px;padding:4px 8px;border-radius:6px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
  .bc{background:rgba(155,89,182,0.2);color:#b58ec9;border:1px solid rgba(155,89,182,0.4)}
  .be{background:rgba(74,158,255,0.2);color:#6ba4f7;border:1px solid rgba(74,158,255,0.4)}
  .ba{background:rgba(74,222,128,0.2);color:#5dcf87;border:1px solid rgba(74,222,128,0.4)}
  .bf{background:rgba(240,201,110,0.2);color:#e5c57d;border:1px solid rgba(240,201,110,0.4)}
  .bct{background:rgba(26,188,156,0.2);color:#45bfa4;border:1px solid rgba(26,188,156,0.4)}
  .ei{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:12px;background:rgba(42,50,64,0.3);border-radius:8px;margin-bottom:8px;border:1px solid var(--border)}
  .ei:hover{background:rgba(42,50,64,0.5);border-color:rgba(240,201,110,0.3)}
  .en{font-weight:700;font-size:13px;margin-bottom:4px}
  .em{font-size:11px;color:var(--muted)}
  .et{font-size:9px;padding:3px 8px;border-radius:4px;font-weight:700;margin-top:4px;display:inline-block}
  .et.eficiente{background:rgba(74,222,128,0.2);color:var(--green);border:1px solid rgba(74,222,128,0.3)}
  .et.neutro{background:rgba(240,201,110,0.2);color:var(--gold);border:1px solid rgba(240,201,110,0.3)}
  .et.ineficiente{background:rgba(248,113,113,0.2);color:var(--red);border:1px solid rgba(248,113,113,0.3)}
  .sr{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
  .sr:last-child{border-bottom:none}
  .sn{width:150px;font-size:12px;font-weight:600}
  .sbw{flex:1;height:10px;background:rgba(42,50,64,0.5);border-radius:5px;overflow:hidden}
  .sb{height:10px;border-radius:5px;transition:width 0.3s}
  .sv{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;min-width:50px;text-align:right}
  .di{padding:16px;background:rgba(42,50,64,0.3);border-radius:8px;margin-bottom:12px;border-left:4px solid;display:flex;gap:12px;align-items:flex-start}
  .di.bad{border-left-color:var(--red);background:rgba(248,113,113,0.08)}
  .di.warn{border-left-color:var(--gold);background:rgba(240,201,110,0.08)}
  .di.good{border-left-color:var(--green);background:rgba(74,222,128,0.08)}
  .dico{font-size:24px;flex-shrink:0}
  .dtt{font-weight:700;font-size:13px;margin-bottom:6px}
  .dtx{font-size:12px;color:var(--muted);line-height:1.5}
  .liq-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
  .liq-row:last-child{border-bottom:none}
  .ld{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .ln{width:100px;font-weight:700}
  .lbwrap{flex:1;height:6px;background:#1a1f28;border-radius:3px;overflow:hidden}
  .lbar{height:6px;border-radius:3px}
  .ltag{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:700;margin-left:4px}
  .ltag.instant{background:rgba(74,222,128,0.2);color:var(--green)}
  .ltag.fast{background:rgba(74,158,255,0.2);color:var(--blue)}
  .ltag.slow{background:rgba(240,201,110,0.2);color:var(--gold)}
  .ltag.illiquid{background:rgba(248,113,113,0.2);color:var(--red)}

  /* MENSAJE DE CONFIGURACI√ìN */
  .config-alert{
    background:linear-gradient(135deg,rgba(248,113,113,0.15),rgba(240,201,110,0.15));
    border:2px solid var(--red);
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
    display:none;
  }
  .config-alert.show{display:block}
  .config-alert h3{color:var(--red);margin-bottom:12px;font-size:16px}
  .config-alert ol{margin-left:20px;line-height:1.8}
  .config-alert code{background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;font-family:'Space Mono',monospace;font-size:12px;color:var(--gold)}
</style>
</head>
<body>

<!-- MENSAJE DE CONFIGURACI√ìN -->
<div class="config-alert" id="config-alert">
  <h3>‚ö†Ô∏è CONFIGURACI√ìN REQUERIDA</h3>
  <p style="margin-bottom:12px">Para conectar con Google Sheets, sigue estos pasos:</p>
  <ol>
    <li>Abre tu Google Sheet: <code>1B3u8KWq2PXr-GHYkV7Uk0LMLBJ9Mir9CTxhE2AW_MYY</code></li>
    <li>Haz clic en <strong>"Compartir"</strong> (esquina superior derecha)</li>
    <li>En "Acceso general", cambia a <strong>"Cualquier persona con el enlace"</strong></li>
    <li>Aseg√∫rate de que el permiso sea <strong>"Lector"</strong></li>
    <li>Verifica que la pesta√±a se llame exactamente <code>RES√öMEN</code></li>
    <li>Verifica que los datos est√©n en el rango <code>A1:S13</code></li>
    <li>Recarga esta p√°gina (F5)</li>
  </ol>
</div>

<div class="container">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">‚óÜ</div>
      <div class="logo-text">Portfolio Intelligence</div>
    </div>
    <div class="header-actions">
      <div class="status" id="status-text">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-msg">Cargando...</span>
      </div>
      <button class="refresh-btn" id="refresh-btn" onclick="loadData()">‚Üª Actualizar</button>
    </div>
  </div>
  
  <div class="loading-bar-wrap">
    <div class="loading-bar" id="lb"></div>
  </div>
  <div class="loading-status" id="lstat">Inicializando...</div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('resumen',this)">üìä Resumen</button>
    <button class="tab" onclick="showTab('distribucion',this)">üéØ Distribuci√≥n</button>
    <button class="tab" onclick="showTab('riesgo',this)">‚ö†Ô∏è Riesgo</button>
    <button class="tab" onclick="showTab('profundo',this)">üî¨ An√°lisis Profundo</button>
    <button class="tab" onclick="showTab('detalle',this)">üìã Detalle Completo</button>
  </div>

  <!-- RESUMEN -->
  <div class="tab-panel active" id="tab-resumen">
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="kpi-card"><div class="kpi-label">Saldo Total</div><div class="kpi-val green" id="kpi-saldo">‚Äî</div><div class="kpi-sub">Portafolio actual</div></div>
      <div class="kpi-card"><div class="kpi-label">Capital Invertido</div><div class="kpi-val" id="kpi-inv">‚Äî</div><div class="kpi-sub">Total aportado</div></div>
      <div class="kpi-card"><div class="kpi-label">P&L Total</div><div class="kpi-val" id="kpi-pyg">‚Äî</div><div class="kpi-sub" id="kpi-pyg-sub">‚Äî</div></div>
      <div class="kpi-card"><div class="kpi-label">ROI Global</div><div class="kpi-val" id="kpi-roi">‚Äî</div><div class="kpi-sub">Rentabilidad total</div></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot"></span>Mapa de Calor por Rentabilidad</div>
      <div id="treemap" style="position:relative;height:280px"></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--green)"></span>Top 5 Mejores Activos</div><div id="top5"></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--red)"></span>Top 5 Peores Activos</div><div id="bot5"></div></div>
    </div>
  </div>

  <!-- DISTRIBUCI√ìN -->
  <div class="tab-panel" id="tab-distribucion">
    <div class="grid-2" style="margin-bottom:16px">
      <div class="panel"><div class="panel-title"><span class="dot"></span>Por Clase de Activo</div><div style="height:280px;position:relative"><canvas id="cClase"></canvas></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--blue)"></span>Por Broker / Custodio</div><div style="height:280px;position:relative"><canvas id="cBroker"></canvas></div></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--purple)"></span>Por Sector</div><div style="height:280px;position:relative"><canvas id="cSector"></canvas></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--green)"></span>Por Geograf√≠a</div><div style="height:280px;position:relative"><canvas id="cGeo"></canvas></div></div>
    </div>
  </div>

  <!-- RIESGO -->
  <div class="tab-panel" id="tab-riesgo">
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="kpi-card red"><div class="kpi-label">Volatilidad Portafolio</div><div class="kpi-val red" id="kpi-vol2">‚Äî</div><div class="kpi-sub">Ponderada por peso</div></div>
      <div class="kpi-card red"><div class="kpi-label">Max Drawdown Est.</div><div class="kpi-val red" id="kpi-mdd2">‚Äî</div><div class="kpi-sub">Escenario adverso</div></div>
      <div class="kpi-card gold"><div class="kpi-label">Ratio Sharpe</div><div class="kpi-val gold" id="kpi-sharpe2">‚Äî</div><div class="kpi-sub">Retorno/Riesgo</div></div>
      <div class="kpi-card purple"><div class="kpi-label">Exposici√≥n DD Severo</div><div class="kpi-val" style="color:var(--purple)" id="kpi-ddexp">‚Äî</div><div class="kpi-sub">Activos >70% vol</div></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot"></span>Mapa Riesgo / Retorno por Activo</div>
      <div style="height:320px;position:relative"><canvas id="cScatter"></canvas></div>
    </div>
    <div class="grid-2">
      <div class="panel"><div class="panel-title"><span class="dot"></span>Volatilidad Estimada por Activo (%)</div><div style="height:260px;position:relative"><canvas id="cVol"></canvas></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--red)"></span>Max Drawdown Estimado por Activo</div><div style="height:260px;position:relative"><canvas id="cDD"></canvas></div></div>
    </div>
    <div class="panel" style="margin-top:16px">
      <div class="panel-title"><span class="dot" style="background:var(--blue)"></span>Mapa de Liquidez</div>
      <div id="liq-map"></div>
    </div>
  </div>

  <!-- PROFUNDO -->
  <div class="tab-panel" id="tab-profundo">
    <div class="grid-2" style="margin-bottom:16px">
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--green)"></span>Activos Eficientes</div><div id="eficientes"></div></div>
      <div class="panel"><div class="panel-title"><span class="dot" style="background:var(--red)"></span>Activos Ineficientes</div><div id="ineficientes"></div></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot" style="background:var(--red)"></span>Exposici√≥n a Drawdown Severo (>‚àí50%)</div>
      <div style="height:160px;position:relative"><canvas id="cDDExp"></canvas></div>
    </div>
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-title"><span class="dot" style="background:var(--blue)"></span>Score de Calidad por Dimensi√≥n</div>
      <div id="quality" style="padding:8px 0"></div>
    </div>
    <div class="panel">
      <div class="panel-title"><span class="dot" style="background:var(--gold)"></span>Diagn√≥stico Integral y Recomendaciones</div>
      <div id="diag"></div>
    </div>
  </div>

  <!-- DETALLE -->
  <div class="tab-panel" id="tab-detalle">
    <div class="panel">
      <div class="panel-title"><span class="dot"></span>Tabla Detallada de Posiciones</div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th>TICKER</th><th>CLASE</th><th>CUSTODIO</th><th>DIVISA</th>
            <th>INVERTIDO</th><th>SALDO</th><th>P&L</th>
            <th>ROI</th><th>PESO %</th><th>VOL.</th><th>MAX DD</th><th>EFICIENCIA</th>
          </tr></thead>
          <tbody id="tabla"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================================
// CONFIGURACI√ìN DE GOOGLE SHEETS
// ============================================================
const SHEET_ID = '1B3u8KWq2PXr-GHYkV7Uk0LMLBJ9Mir9CTxhE2AW_MYY';
const SHEET_NAME = 'RES√öMEN'; // DEBE COINCIDIR EXACTAMENTE CON EL NOMBRE DE TU PESTA√ëA
const RANGE = 'A1:S13'; // Tu rango de datos

// URL mejorada con rango espec√≠fico
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;

console.log('üì° URL de conexi√≥n:', GVIZ_URL);

// ============================================================
// DATOS DE RESPALDO (se usan si no hay conexi√≥n)
// ============================================================
const FALLBACK = [
  {ticker:'NU BANK', broker:'NU HOLDINGS', div:'COP', inv:10000000, pyg:494315,   saldo:10494315, roi:0.0494, clase:'Cuenta Rentable', sector:'Liquidez',     geo:'LATAM',    vol:0.5, maxdd:-2,  liquidity:'instant'},
  {ticker:'DIN√ÅMICO',broker:'ACCIVALORES',  div:'COP', inv:3411934,  pyg:1061098,  saldo:4473032,  roi:0.3110, clase:'FIC',             sector:'Diversificado', geo:'Colombia', vol:2,   maxdd:-8,  liquidity:'fast'},
  {ticker:'VWRA',    broker:'IBKR',         div:'USD', inv:6204544,  pyg:-101716,  saldo:6102828,  roi:-0.0164,clase:'ETF',             sector:'Global Eq.',    geo:'Global',   vol:15,  maxdd:-38, liquidity:'fast'},
  {ticker:'WSML',    broker:'IBKR',         div:'USD', inv:842382,   pyg:56876,    saldo:899258,   roi:0.0675, clase:'ETF',             sector:'Small Cap',     geo:'Global',   vol:22,  maxdd:-45, liquidity:'fast'},
  {ticker:'AGGU',    broker:'IBKR',         div:'USD', inv:1349340,  pyg:-47427,   saldo:1301913,  roi:-0.0351,clase:'ETF',             sector:'Renta Fija',    geo:'Global',   vol:6,   maxdd:-20, liquidity:'fast'},
  {ticker:'SGOL',    broker:'IBKR',         div:'USD', inv:1021730,  pyg:100663,   saldo:1122393,  roi:0.0985, clase:'ETF',             sector:'Commodities',   geo:'Global',   vol:13,  maxdd:-22, liquidity:'fast'},
  {ticker:'TESLA',   broker:'HAPI',         div:'USD', inv:370873,   pyg:31395,    saldo:402268,   roi:0.0847, clase:'Acci√≥n',          sector:'Tech',          geo:'EE.UU',    vol:65,  maxdd:-75, liquidity:'fast'},
  {ticker:'NU',      broker:'HAPI',         div:'USD', inv:400418,   pyg:45631,    saldo:446049,   roi:0.1140, clase:'Acci√≥n',          sector:'Fintech',       geo:'LATAM',    vol:50,  maxdd:-65, liquidity:'fast'},
  {ticker:'BTC',     broker:'LEDGER',       div:'USD', inv:12078551, pyg:-95066,   saldo:11983485, roi:-0.0079,clase:'Cripto',           sector:'Cripto',        geo:'Global',   vol:75,  maxdd:-80, liquidity:'instant'},
  {ticker:'XRP',     broker:'LEDGER',       div:'USD', inv:567112,   pyg:151516,   saldo:718628,   roi:0.2672, clase:'Cripto',           sector:'Cripto',        geo:'Global',   vol:90,  maxdd:-92, liquidity:'instant'},
  {ticker:'ETH',     broker:'LEDGER',       div:'USD', inv:904202,   pyg:-615279,  saldo:288923,   roi:-0.6805,clase:'Cripto',           sector:'Cripto',        geo:'Global',   vol:85,  maxdd:-90, liquidity:'instant'},
  {ticker:'XAUT',    broker:'BITGET',       div:'USD', inv:208392,   pyg:80339,    saldo:288731,   roi:0.3855, clase:'Cripto',           sector:'Oro Digital',   geo:'Global',   vol:13,  maxdd:-22, liquidity:'fast'},
];

// ============================================================
// MAPAS DE CLASIFICACI√ìN
// ============================================================
const CM={'NU BANK':'Cuenta Rentable','DIN√ÅMICO':'FIC','DINAMICO':'FIC','VWRA':'ETF','WSML':'ETF','AGGU':'ETF','SGOL':'ETF','TESLA':'Acci√≥n','NU':'Acci√≥n','BTC':'Cripto','XRP':'Cripto','ETH':'Cripto','XAUT':'Cripto'};
const SM={'NU BANK':'Liquidez','DIN√ÅMICO':'Diversificado','DINAMICO':'Diversificado','VWRA':'Global Eq.','WSML':'Small Cap','AGGU':'Renta Fija','SGOL':'Commodities','TESLA':'Tech','NU':'Fintech','BTC':'Cripto','XRP':'Cripto','ETH':'Cripto','XAUT':'Oro Digital'};
const GM={'NU BANK':'LATAM','DIN√ÅMICO':'Colombia','DINAMICO':'Colombia','VWRA':'Global','WSML':'Global','AGGU':'Global','SGOL':'Global','TESLA':'EE.UU','NU':'LATAM','BTC':'Global','XRP':'Global','ETH':'Global','XAUT':'Global'};
const VM={'NU BANK':0.5,'DIN√ÅMICO':2,'DINAMICO':2,'VWRA':15,'WSML':22,'AGGU':6,'SGOL':13,'TESLA':65,'NU':50,'BTC':75,'XRP':90,'ETH':85,'XAUT':13};
const DM={'NU BANK':-2,'DIN√ÅMICO':-8,'DINAMICO':-8,'VWRA':-38,'WSML':-45,'AGGU':-20,'SGOL':-22,'TESLA':-75,'NU':-65,'BTC':-80,'XRP':-92,'ETH':-90,'XAUT':-22};
const LM={'NU BANK':'instant','DIN√ÅMICO':'fast','DINAMICO':'fast','VWRA':'fast','WSML':'fast','AGGU':'fast','SGOL':'fast','TESLA':'fast','NU':'fast','BTC':'instant','XRP':'instant','ETH':'instant','XAUT':'fast'};
const COLORS={'Cripto':'#9b59b6','ETF':'#4a9eff','Acci√≥n':'#2ecc71','FIC':'#c9a84c','Cuenta Rentable':'#1abc9c'};
const GC=['#2ecc71','#4a9eff','#c9a84c','#9b59b6','#e74c3c','#1abc9c','#f39c12'];

Chart.defaults.color='#7a8499';Chart.defaults.borderColor='#1e2530';Chart.defaults.font.family="'Space Mono',monospace";Chart.defaults.font.size=11;
let ch={};
const dc=id=>{if(ch[id]){ch[id].destroy();delete ch[id];}};
const fc=v=>{if(Math.abs(v)>=1e9)return'$'+(v/1e9).toFixed(2)+'B';if(Math.abs(v)>=1e6)return'$'+(v/1e6).toFixed(2)+'M';if(Math.abs(v)>=1e3)return'$'+(v/1e3).toFixed(1)+'K';return'$'+v.toFixed(0);};
const fp=v=>(v>=0?'+':'')+(v*100).toFixed(1)+'%';
const tn=v=>{if(!v||v==='-'||v==='--')return 0;return parseFloat(String(v).replace(/,/g,'').replace(/%/g,''))||0;};
const sl=(p,m)=>{document.getElementById('lb').style.width=p+'%';document.getElementById('lstat').textContent=m;};

function showTab(name,el){document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+name).classList.add('active');el.classList.add('active');}

function parseGvizJson(text){
  const match=text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);?\s*$/);
  if(!match){
    console.error('‚ùå No se pudo parsear la respuesta. Formato inesperado.');
    return[];
  }
  const json=JSON.parse(match[1]);
  if(!json.table||!json.table.cols||!json.table.rows){
    console.error('‚ùå Respuesta vac√≠a o sin estructura esperada');
    return[];
  }
  const headers=json.table.cols.map(c=>(c.label||'').toUpperCase().trim());
  console.log('üìã Headers encontrados:', headers);
  
  const rows = json.table.rows.map(row=>{
    const o={};
    row.c.forEach((cell,i)=>{
      if(i<headers.length&&headers[i]&&cell){
        const v=cell.v;
        o[headers[i]]=(v!==undefined&&v!==null)?String(v):'';
      }
    });
    return o;
  }).filter(r=>Object.values(r).some(v=>v&&v!==''));
  
  console.log(`‚úÖ ${rows.length} filas parseadas exitosamente`);
  return rows;
}

function rowsToAssets(rows){
  return rows.map(r=>{
    const ticker=(r['TICKER']||r['ACTIVO']||'').toUpperCase().trim();
    const broker=r['BROKER']||r['CUSTODIO']||'';
    const div=r['DIVISA']||'COP';
    const inv=tn(r['INVERTIDO']||r['CAPITAL']||0);
    const pyg=tn(r["P&G"]||r["P&L"]||r['GANANCIA']||0);
    const saldo=tn(r['SALDO']||r['VALOR']||0)||(inv+pyg);
    const roi=tn(r['ROI']||0)||(inv>0?pyg/inv:0);
    const clase=(r['CLASE']||'').trim()||CM[ticker]||'Otro';
    const sector=(r['SECTOR']||'').trim()||SM[ticker]||'Otro';
    const geo=(r['GEO']||r['GEOGRAFIA']||'').trim()||GM[ticker]||'Global';
    const vol=tn(r['VOL']||r['VOLATILIDAD']||0)||VM[ticker]||20;
    const maxdd=tn(r['MAX_DD']||r['MAXDD']||r['MAX DD']||0)||DM[ticker]||-30;
    const liquidity=(r['LIQUIDEZ']||r['LIQ']||'').trim().toLowerCase()||LM[ticker]||'fast';
    return{ticker,broker,div,inv,pyg,saldo,roi,clase,sector,geo,vol,maxdd,liquidity};
  }).filter(a=>a.ticker&&a.saldo>0);
}

function enrichFallback(data){
  return data.map(a=>{const t=a.ticker;return{...a,clase:a.clase||CM[t]||'Otro',sector:a.sector||SM[t]||'Otro',geo:a.geo||GM[t]||'Global',vol:a.vol||VM[t]||20,maxdd:a.maxdd||DM[t]||-30,liquidity:a.liquidity||LM[t]||'fast'};});
}

async function loadData(){
  const btn=document.getElementById('refresh-btn');
  const statusMsg=document.getElementById('status-msg');
  const statusDot=document.getElementById('status-dot');
  const configAlert=document.getElementById('config-alert');
  
  btn.classList.add('spinning');
  sl(10,'Conectando con Google Sheets...');
  statusMsg.textContent='Conectando...';
  
  let assets=null,isLive=false;
  try{
    sl(30,'Descargando datos...');
    console.log('üì° Intentando conectar:', GVIZ_URL);
    
    const res=await fetch(GVIZ_URL+'&t='+Date.now());
    console.log('üì° Respuesta HTTP:', res.status, res.statusText);
    
    if(!res.ok){
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const text=await res.text();
    console.log('üìÑ Tama√±o de respuesta:', text.length, 'caracteres');
    
    if(!text||text.length<20){
      throw new Error('Respuesta vac√≠a o muy corta');
    }
    
    // Verificar si es un error de acceso
    if(text.includes('Forbidden') || text.includes('403')){
      throw new Error('Acceso denegado - La hoja debe ser p√∫blica');
    }
    
    sl(60,'Procesando datos...');
    const rows=parseGvizJson(text);
    
    if(!rows.length){
      throw new Error('No se encontraron datos en la respuesta. Verifica el nombre de la pesta√±a y el rango.');
    }
    
    assets=rowsToAssets(rows);
    
    if(assets.length){
      isLive=true;
      console.log('‚úÖ CONECTADO CON GOOGLE SHEETS ‚Äî',assets.length,'activos cargados');
      statusMsg.textContent='Conectado en vivo';
      statusDot.style.background='var(--green)';
      configAlert.classList.remove('show');
    }else{
      throw new Error('No se pudieron parsear activos v√°lidos');
    }
  }catch(e){
    console.warn('‚ö†Ô∏è Google Sheets no disponible:',e.message);
    console.warn('üì¶ Usando datos locales de respaldo');
    statusMsg.textContent='Modo local (sin conexi√≥n)';
    statusDot.style.background='var(--gold)';
    configAlert.classList.add('show');
  }
  
  if(!assets||!assets.length){
    assets=enrichFallback(FALLBACK);
    console.log('üì¶ Datos locales cargados:',assets.length,'activos');
  }
  
  sl(80,'Generando visualizaciones...');
  render(assets);
  sl(100,'Completado');
  setTimeout(()=>{sl(0,'');document.getElementById('lstat').textContent='';},1000);
  btn.classList.remove('spinning');
}

function render(A){
  const tI=A.reduce((s,a)=>s+a.inv,0);
  const tS=A.reduce((s,a)=>s+a.saldo,0);
  const tP=A.reduce((s,a)=>s+a.pyg,0);
  const roiG=tI>0?tP/tI:0;
  const volP=Math.sqrt(A.reduce((s,a)=>s+Math.pow(a.vol/100,2)*(a.saldo/tS),0))*100;
  const ddP=A.reduce((s,a)=>s+(a.maxdd/100)*(a.saldo/tS),0)*100;
  const sharpe=volP>0?(roiG*100/volP).toFixed(2):'0.00';
  const ddSev=A.filter(a=>a.maxdd<=-50).reduce((s,a)=>s+a.saldo,0);
  document.getElementById('kpi-saldo').textContent=fc(tS);
  document.getElementById('kpi-inv').textContent=fc(tI);
  document.getElementById('kpi-pyg').textContent=fc(tP);
  document.getElementById('kpi-pyg').className='kpi-val '+(tP>=0?'green':'red');
  document.getElementById('kpi-pyg-sub').textContent=fp(roiG);
  document.getElementById('kpi-roi').textContent=fp(roiG);
  document.getElementById('kpi-roi').className='kpi-val '+(roiG>=0?'green':'red');
  document.getElementById('kpi-vol2').textContent=volP.toFixed(1)+'%';
  document.getElementById('kpi-mdd2').textContent=ddP.toFixed(1)+'%';
  document.getElementById('kpi-sharpe2').textContent=sharpe;
  document.getElementById('kpi-ddexp').textContent=fc(ddSev)+' ('+(ddSev/tS*100).toFixed(1)+'%)';
  bClase(A,tS);bBroker(A,tS);bTop5(A);bTreemap(A,tS);
  bSector(A,tS);bGeo(A,tS);bScatter(A,tS);
  bVol(A);bDD(A);bLiq(A,tS);
  bEff(A);bDDExp(A,tS);bQuality(A,roiG,sharpe);
  bDiag(A,tS,roiG,sharpe);bTabla(A,tS);
}

function bClase(A,tS){dc('cClase');const m={};A.forEach(a=>{m[a.clase]=(m[a.clase]||0)+a.saldo;});const L=Object.keys(m);ch['cClase']=new Chart(document.getElementById('cClase'),{type:'doughnut',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:L.map(l=>COLORS[l]||'#666'),borderColor:'#0a0c0f',borderWidth:3,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:12,boxWidth:10}},tooltip:{callbacks:{label:c=>` ${c.label}: ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}}}});}
function bBroker(A,tS){dc('cBroker');const m={};A.forEach(a=>{m[a.broker]=(m[a.broker]||0)+a.saldo;});const L=Object.keys(m).sort((a,b)=>m[b]-m[a]);const C=['#c9a84c','#4a9eff','#9b59b6','#2ecc71','#1abc9c','#e74c3c','#f39c12'];ch['cBroker']=new Chart(document.getElementById('cBroker'),{type:'bar',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:C.slice(0,L.length),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>fc(v)}},y:{grid:{display:false}}}}});}
function bTop5(A){const s=[...A].sort((a,b)=>b.roi-a.roi),t5=s.slice(0,5),b5=s.slice(-5).reverse();const mR=Math.abs(t5[0].roi)||1,mB=Math.abs(b5[0].roi)||1;const mk=(d,el,mx)=>{el.innerHTML='';d.forEach(a=>{const c=a.roi>=0?'var(--green)':'var(--red)';el.innerHTML+=`<div class="top5-item"><span class="t5n">${a.ticker}</span><div class="t5bw"><div class="t5b" style="width:${Math.abs(a.roi/mx)*100}%;background:${c}"></div></div><span class="t5v ${a.roi>=0?'green':'red'}">${fp(a.roi)}</span></div>`;});};mk(t5,document.getElementById('top5'),mR);mk(b5,document.getElementById('bot5'),mB);}
function bTreemap(A,tS){const c=document.getElementById('treemap');c.innerHTML='';const W=c.offsetWidth||900,H=280;c.style.height=H+'px';const items=[...A].sort((a,b)=>b.saldo-a.saldo);const gc=r=>{if(r>=.2)return'#1a6b3c';if(r>=.08)return'#1e5c35';if(r>=.01)return'#1a4a2e';if(r>=-.01)return'#2a3020';if(r>=-.1)return'#4a2020';return'#5c1414';};function lay(its,x,y,w,h){if(!its.length)return[];const res=[];let rem=[...its],rx=x,ry=y,rw=w,rh=h;while(rem.length){const isH=rw>=rh;let rI=[],rS=0,best=Infinity;for(let i=0;i<rem.length;i++){const cnd=rem.slice(0,i+1);const sum=cnd.reduce((s,c)=>s+c.saldo,0);const remS=rem.reduce((s,c)=>s+c.saldo,0);const rl=(sum/remS)*(isH?rw:rh);const sd=isH?rh:rw;const w2=Math.max(...cnd.map(c=>{const h2=(c.saldo/sum)*sd,ww=rl;return Math.max(h2/ww,ww/h2);}));if(w2<best){best=w2;rI=cnd.slice();rS=sum;}else break;}if(!rI.length){rI=[rem[0]];rS=rem[0].saldo;}const remS=rem.reduce((s,c)=>s+c.saldo,0);const rl=(rS/remS)*(isH?rw:rh);let pos=isH?ry:rx;rI.forEach(item=>{const fr=item.saldo/rS;const cw=isH?rl:fr*rw,ch=isH?fr*rh:rl;const cx=isH?rx:pos,cy=isH?pos:ry;res.push({...item,x:cx,y:cy,w:cw,h:ch});pos+=isH?ch:cw;});rem=rem.slice(rI.length);if(isH){rx+=rl;rw-=rl;}else{ry+=rl;rh-=rl;}}return res;}
lay(items,0,0,W,H).forEach(cell=>{const d=document.createElement('div');d.className='tc';d.style.cssText=`left:${cell.x}px;top:${cell.y}px;width:${Math.max(cell.w-2,1)}px;height:${Math.max(cell.h-2,1)}px;background:${gc(cell.roi)};`;const rc=cell.roi>=0?'#4ade80':'#f87171';if(cell.w>50&&cell.h>30)d.innerHTML=`<span class="cn">${cell.ticker}</span><span class="cr" style="color:${rc}">${fp(cell.roi)}</span>`;else if(cell.w>25&&cell.h>18)d.innerHTML=`<span class="cn" style="font-size:9px">${cell.ticker}</span>`;d.title=`${cell.ticker}: ${fc(cell.saldo)} ¬∑ ROI: ${fp(cell.roi)}`;c.appendChild(d);});}
function bSector(A,tS){dc('cSector');const m={};A.forEach(a=>{m[a.sector]=(m[a.sector]||0)+a.saldo;});const L=Object.keys(m).sort((a,b)=>m[b]-m[a]);const C=['#4a9eff','#9b59b6','#2ecc71','#c9a84c','#1abc9c','#e74c3c','#f39c12','#3498db'];ch['cSector']=new Chart(document.getElementById('cSector'),{type:'bar',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:C.slice(0,L.length),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>fc(v)}},y:{grid:{display:false}}}}});}
function bGeo(A,tS){dc('cGeo');const m={};A.forEach(a=>{m[a.geo]=(m[a.geo]||0)+a.saldo;});const L=Object.keys(m);ch['cGeo']=new Chart(document.getElementById('cGeo'),{type:'doughnut',data:{labels:L,datasets:[{data:L.map(l=>m[l]),backgroundColor:GC.slice(0,L.length),borderColor:'#0a0c0f',borderWidth:3,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:12,boxWidth:10}},tooltip:{callbacks:{label:c=>` ${c.label}: ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}}}});}
function bScatter(A,tS){dc('cScatter');const ds=Object.keys(COLORS).map(cl=>({label:cl,data:A.filter(a=>a.clase===cl).map(a=>({x:a.vol,y:a.roi*100,label:a.ticker})),backgroundColor:COLORS[cl]+'cc',pointRadius:A.filter(a=>a.clase===cl).map(a=>Math.max(6,Math.sqrt(a.saldo/tS)*80)),pointHoverRadius:12})).filter(d=>d.data.length);ch['cScatter']=new Chart(document.getElementById('cScatter'),{type:'scatter',data:{datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},tooltip:{callbacks:{label:c=>` ${c.raw.label}: ROI ${c.raw.y.toFixed(1)}% ¬∑ Vol ${c.raw.x}%`}}},scales:{x:{title:{display:true,text:'Volatilidad (%)',color:'#7a8499'},grid:{color:'#1e2530'},min:0},y:{title:{display:true,text:'ROI (%)',color:'#7a8499'},grid:{color:'#1e2530'}}}}});}
function bVol(A){dc('cVol');const s=[...A].sort((a,b)=>b.vol-a.vol);ch['cVol']=new Chart(document.getElementById('cVol'),{type:'bar',data:{labels:s.map(a=>a.ticker),datasets:[{data:s.map(a=>a.vol),backgroundColor:s.map(a=>a.vol>50?'#e74c3c':a.vol>20?'#f0c96e':'#2ecc71'),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw}% vol. anual est.`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>v+'%'},max:100},y:{grid:{display:false},ticks:{font:{size:10}}}}}});}
function bDD(A){dc('cDD');const s=[...A].sort((a,b)=>a.maxdd-b.maxdd);ch['cDD']=new Chart(document.getElementById('cDD'),{type:'bar',data:{labels:s.map(a=>a.ticker),datasets:[{data:s.map(a=>a.maxdd),backgroundColor:s.map(a=>a.maxdd<-60?'#e74c3c':a.maxdd<-30?'#f0c96e':'#4a9eff'),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw}% DD m√°ximo est.`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>v+'%'},max:0,min:-100},y:{grid:{display:false},ticks:{font:{size:10}}}}}});}
function bLiq(A,tS){const c=document.getElementById('liq-map');c.innerHTML='';const lc={instant:'#2ecc71',fast:'#4a9eff',slow:'#c9a84c',illiquid:'#e74c3c'};const ll={instant:'Inmediata',fast:'R√°pida (1-3d)',slow:'Lenta (7-30d)',illiquid:'Il√≠quida'};[...A].sort((a,b)=>b.saldo-a.saldo).forEach(a=>{const p=(a.saldo/tS*100).toFixed(1);c.innerHTML+=`<div class="liq-row"><div class="ld" style="background:${lc[a.liquidity]}"></div><div class="ln">${a.ticker}</div><div class="lbwrap"><div class="lbar" style="width:${p}%;background:${lc[a.liquidity]}"></div></div><span style="font-size:11px;font-family:'Space Mono';min-width:50px;text-align:right">${p}%</span><span class="ltag ${a.liquidity}">${ll[a.liquidity]}</span><span style="font-size:11px;color:var(--muted);min-width:80px;text-align:right;font-family:'Space Mono'">${fc(a.saldo)}</span></div>`;});}
function bEff(A){const ef=[],in2=[];A.forEach(a=>{const sc=a.roi/(a.vol/100+0.001);let st,reason;if(a.roi>=0.08&&a.vol<=15){st='eficiente';reason=`ROI +${(a.roi*100).toFixed(1)}% con baja volatilidad (${a.vol}%)`;}else if(a.roi<-0.03||(a.roi<0.05&&a.vol>60)){st='ineficiente';reason=a.roi<-0.1?`P√©rdida severa (${fp(a.roi)}) con alta vol (${a.vol}%)`:`Bajo retorno vs riesgo (vol ${a.vol}%)`;}else{st='neutro';reason=`Perfil mixto ¬∑ ROI ${fp(a.roi)} ¬∑ Vol ${a.vol}%`;}(st==='ineficiente'?in2:ef).push({...a,st,reason});});const rend=(items,el)=>{el.innerHTML='';[...items].sort((a,b)=>b.roi-a.roi).forEach(a=>{el.innerHTML+=`<div class="ei"><div><div class="en">${a.ticker} <span style="font-size:11px;color:var(--muted);font-weight:400">¬∑ ${a.clase}</span></div><div class="em">${a.reason}</div></div><div style="text-align:right"><div style="font-family:'Space Mono';font-size:13px;color:${a.roi>=0?'var(--green)':'var(--red)'}">${fp(a.roi)}</div><span class="et ${a.st}">${st.toUpperCase()}</span></div></div>`;});if(!items.length)el.innerHTML='<p style="color:var(--muted);font-size:12px;padding:12px">Ninguno en esta categor√≠a</p>';};rend(ef,document.getElementById('eficientes'));rend(in2,document.getElementById('ineficientes'));}
function bDDExp(A,tS){dc('cDDExp');const sev=A.filter(a=>a.maxdd<=-50),norm=A.filter(a=>a.maxdd>-50);const vn=norm.reduce((s,a)=>s+a.saldo,0);ch['cDDExp']=new Chart(document.getElementById('cDDExp'),{type:'bar',data:{labels:sev.map(a=>a.ticker).concat(['Resto portafolio']),datasets:[{data:sev.map(a=>a.saldo).concat([vn]),backgroundColor:sev.map(a=>a.saldo>5e6?'#e74c3c':'#e74c3c88').concat(['#2ecc71']),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fc(c.raw)} (${(c.raw/tS*100).toFixed(1)}%)`}}},scales:{x:{grid:{color:'#1e2530'},ticks:{callback:v=>fc(v)}},y:{grid:{display:false}}}}});}
function bQuality(A,roiG,sharpe){const tS=A.reduce((s,a)=>s+a.saldo,0);const t1=[...A].sort((a,b)=>b.saldo-a.saldo)[0];const con=t1?t1.saldo/tS:0;const liqS=A.filter(a=>a.liquidity==='instant'||a.liquidity==='fast').reduce((s,a)=>s+a.saldo,0)/tS*100;const scores=[{d:'Diversificaci√≥n',v:Math.round(Math.max(0,100-con*150)),n:`${t1?.ticker||'?'} concentra ${(con*100).toFixed(0)}%`},{d:'Liquidez',v:Math.round(liqS),n:'Mayor√≠a inmediata/r√°pida'},{d:'Eficiencia (Sharpe)',v:Math.max(5,Math.min(95,Math.round(parseFloat(sharpe)*40))),n:`Sharpe ${sharpe}`},{d:'Cobertura',v:45,n:'Sin cobertura expl√≠cita'},{d:'Calidad activos',v:62,n:'Mix ETFs + cripto + FIC'},{d:'Rentabilidad',v:Math.round(Math.max(5,Math.min(95,roiG*200+40))),n:`ROI global ${fp(roiG)}`}];const c=document.getElementById('quality');c.innerHTML='';scores.forEach(s=>{const col=s.v>=70?'var(--green)':s.v>=50?'var(--gold2)':'var(--red)';c.innerHTML+=`<div class="sr"><span class="sn">${s.d}</span><div class="sbw"><div class="sb" style="width:${s.v}%;background:${col}"></div></div><span class="sv" style="color:${col}">${s.v}/100</span><span style="font-size:11px;color:var(--muted);margin-left:12px;font-family:'Space Mono'">${s.n}</span></div>`;});}
function bDiag(A,tS,roiG,sharpe){const worst=[...A].sort((a,b)=>a.roi-b.roi)[0];const best=[...A].filter(a=>a.roi>0.05&&a.vol<15).sort((a,b)=>b.roi-a.roi)[0];const top1=[...A].sort((a,b)=>b.saldo-a.saldo)[0];const conc=(top1.saldo/tS*100).toFixed(1);const items=[worst.roi<-0.15?{t:'bad',i:'‚ö†Ô∏è',tt:`${worst.ticker}: Posici√≥n en p√©rdida severa (${fp(worst.roi)})`,tx:`${worst.ticker} acumula ${fc(worst.pyg)} COP de p√©rdida sobre ${fc(worst.inv)} COP invertidos. Representa el ${(worst.saldo/tS*100).toFixed(1)}% del portafolio. Considera definir un umbral de salida o reasignar hacia activos m√°s eficientes.`}:null,parseFloat(conc)>25?{t:'bad',i:'üî¥',tt:`Concentraci√≥n excesiva en ${top1.ticker} (${conc}%)`,tx:`${top1.ticker} representa el ${conc}% del portafolio total. Una correcci√≥n del 30% en este activo impactar√≠a el portafolio en ~${(parseFloat(conc)*0.3).toFixed(1)}%. M√°ximo recomendado: 20-25% por activo.`}:null,parseFloat(sharpe)<0.3?{t:'warn',i:'üìä',tt:`Sharpe Ratio bajo (${sharpe}) ‚Äî Eficiencia mejorable`,tx:`El portafolio asume alta volatilidad pero el ROI realizado es ${fp(roiG)}. Aumentar el peso en activos con mejor ratio Sharpe (ETFs globales, FICs, oro) elevar√≠a la eficiencia del portafolio.`}:null,{t:'warn',i:'‚öñÔ∏è',tt:'Ausencia de cobertura (hedge) expl√≠cita',tx:'No hay instrumentos de cobertura expl√≠cita. SGOL y AGGU act√∫an parcialmente como refugio, pero representan poco del portafolio. Objetivo: 10-15% en activos refugio mejora la resiliencia en ca√≠das.'},best?{t:'good',i:'‚úÖ',tt:`${best.ticker}: Activo m√°s eficiente (+${(best.roi*100).toFixed(1)}% ROI ¬∑ Vol ${best.vol}%)`,tx:`${best.ticker} entrega excelente rentabilidad con baja volatilidad. Es el activo m√°s eficiente del portafolio. Considera mantener o incrementar su peso en nuevas contribuciones.`}:null,{t:'good',i:'üíß',tt:'Alta liquidez del portafolio',tx:'La mayor√≠a de posiciones tienen liquidez inmediata o r√°pida (1-3 d√≠as h√°biles). Esto permite rebalancear con flexibilidad total sin penalizaciones de salida anticipada.'}].filter(Boolean);const c=document.getElementById('diag');c.innerHTML='';items.forEach(it=>{c.innerHTML+=`<div class="di ${it.t}"><span class="dico">${it.i}</span><div><div class="dtt">${it.tt}</div><div class="dtx">${it.tx}</div></div></div>`;});}
function bTabla(A,tS){const tb=document.getElementById('tabla');tb.innerHTML='';const bm={'Cripto':'bc','ETF':'be','Acci√≥n':'ba','FIC':'bf','Cuenta Rentable':'bct'};[...A].sort((a,b)=>b.saldo-a.saldo).forEach(a=>{const ef=a.roi/(a.vol/100+0.001);const el=ef>0.5?'EFICIENTE':ef>0?'NEUTRO':'INEFICIENTE';const ec=el==='EFICIENTE'?'var(--green)':el==='NEUTRO'?'var(--gold2)':'var(--red)';tb.innerHTML+=`<tr><td style="font-weight:700">${a.ticker}</td><td><span class="badge ${bm[a.clase]||''}">${a.clase}</span></td><td style="color:var(--muted)">${a.broker}</td><td style="color:var(--muted)">${a.div}</td><td>${fc(a.inv)}</td><td>${fc(a.saldo)}</td><td style="color:${a.pyg>=0?'var(--green)':'var(--red)'}">${fc(a.pyg)}</td><td style="color:${a.roi>=0?'var(--green)':'var(--red)'}">${fp(a.roi)}</td><td style="color:var(--muted)">${(a.saldo/tS*100).toFixed(1)}%</td><td style="color:${a.vol>50?'var(--red)':a.vol>20?'var(--gold2)':'var(--green)'}">${a.vol}%</td><td style="color:${a.maxdd<-60?'var(--red)':a.maxdd<-30?'var(--gold2)':'var(--blue)'}">${a.maxdd}%</td><td style="color:${ec};font-size:11px;font-family:'Syne'">${el}</td></tr>`;});}

// INIT
loadData();
// Auto-refresh cada 5 minutos
setInterval(loadData,5*60*1000);
</script>
</body>
</html>
